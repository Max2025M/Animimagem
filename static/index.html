<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Image â†’ Video Camera Preview</title>

<style>
body{margin:0;background:#111;color:#fff;font-family:Arial,Helvetica,sans-serif}
.app{max-width:1100px;margin:auto;padding:16px}
.block{border-top:2px solid #333;margin-top:20px;padding-top:20px}
.controls{display:grid;grid-template-columns:1fr 1fr;gap:10px}
button,select,input{padding:10px;border-radius:8px;border:none}
button{background:#00e0ff;font-weight:bold}
.preview{display:flex;justify-content:center;margin-top:10px}
.frame{width:100%;max-width:800px;aspect-ratio:16/9;border:3px solid #fff;overflow:hidden}
.frame img{position:absolute;will-change:transform}
video{width:100%;margin-top:10px;display:none}
@media(max-width:600px){.controls{grid-template-columns:1fr}}
</style>
</head>

<body>
<div class="app">
<h2>AnimaÃ§Ã£o de CÃ¢mera</h2>
<input type="file" id="upload" multiple accept="image/*">
<div id="list"></div>
</div>

<script>
const list=document.getElementById('list');

upload.onchange=e=>{
  list.innerHTML='';
  [...e.target.files].forEach(f=>load(f));
};

function load(file){
  const img=new Image();
  img.onload=()=>create(img);
  img.src=URL.createObjectURL(file);
}

function create(img){
  const b=document.createElement('div');
  b.className='block';
  b.innerHTML=`
<select class="animation">
<option value="lr">Esquerda â†’ Direita</option>
<option value="rl">Direita â†’ Esquerda</option>
<option value="tb">Cima â†’ Baixo</option>
<option value="bt">Baixo â†’ Cima</option>
<option value="zoomIn">Zoom In</option>
<option value="zoomOut">Zoom Out</option>
<option value="cinematic">Diagonal</option>
<option value="panH">Pan Horizontal</option>
<option value="panV">Pan Vertical</option>
</select>
<input type="range" class="speed" min="0.5" max="3" step="0.1" value="1">
<button class="previewBtn">â–¶ Preview</button>
<button class="renderBtn">ðŸ’¾ Gerar VÃ­deo</button>

<div class="preview"><div class="frame"><img src="${img.src}"></div></div>
<div class="status"></div>
<video controls></video>
`;
  list.appendChild(b);

  b.querySelector('.previewBtn').onclick=()=>preview(b,img);
  b.querySelector('.renderBtn').onclick=()=>render(b,img);
}

function preview(b,img){
  const f=b.querySelector('.frame');
  const i=b.querySelector('img');
  const anim=b.querySelector('.animation').value;
  const speed=parseFloat(b.querySelector('.speed').value);
  const fw=f.clientWidth, fh=f.clientHeight;
  const iw=img.naturalWidth, ih=img.naturalHeight;
  let s=Math.max(fw/iw,fh/ih)*1.3;
  let t=0;
  function loop(){
    t+=0.01*speed;
    let x=0,y=0,z=s;
    if(anim==='lr')x=(iw*s-fw)*t;
    if(anim==='rl')x=(iw*s-fw)*(1-t);
    if(anim==='tb')y=(ih*s-fh)*t;
    if(anim==='bt')y=(ih*s-fh)*(1-t);
    if(anim==='zoomIn')z=s*(1+0.25*t);
    if(anim==='zoomOut')z=s*(1.25-0.25*t);
    i.style.width=iw*z+'px';
    i.style.height=ih*z+'px';
    i.style.transform=`translate(${-x}px,${-y}px)`;
    requestAnimationFrame(loop);
  }
  loop();
}

async function render(b,img){
  const fd=new FormData();
  fd.append('image',await fetch(img.src).then(r=>r.blob()));
  fd.append('animation',b.querySelector('.animation').value);
  fd.append('speed',b.querySelector('.speed').value);

  const r=await fetch('/render',{method:'POST',body:fd}).then(r=>r.json());
  const id=r.id;
  const s=b.querySelector('.status');
  const v=b.querySelector('video');

  const timer=setInterval(async()=>{
    const p=await fetch('/progress/'+id).then(r=>r.json());
    s.innerText=`Render: ${p.progress||0}%`;
    if(p.done){
      clearInterval(timer);
      v.src=p.url;
      v.style.display='block';
    }
  },1000);
}
</script>
</body>
</html>
